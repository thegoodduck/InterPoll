<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vote Receipt</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; margin: 2rem; }
        .card { max-width: 760px; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        code { background: #f3f4f6; padding: 0.2rem 0.3rem; border-radius: 6px; }
        a { color: #2563eb; text-decoration: none; }
        .row { margin: 0.5rem 0; }
    </style>
    <script>
        function makeReceipt() {
            const el = document.getElementById('rcpt');
            return {
                poll_id: el.dataset.poll,
                entry_hash: el.dataset.entry,
                index: parseInt(el.dataset.index, 10),
                chain_head: el.dataset.head,
                timestamp: el.dataset.ts,
                file_id: el.dataset.file
            };
        }

        function saveLocal() {
            const r = makeReceipt();
            const key = 'interpoll_receipts';
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            // dedupe by entry_hash
            if (!existing.find(x => x.entry_hash === r.entry_hash)) {
                existing.push(r);
                localStorage.setItem(key, JSON.stringify(existing));
            }
            alert('Receipt saved in this browser.');
        }

        function downloadReceipt() {
            const r = makeReceipt();
            const blob = new Blob([JSON.stringify(r, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt_${r.index}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        async function sendToReceipter() {
            const receipterUrl = '{{ receipter_url }}';
            if (!receipterUrl) { 
                const status = document.getElementById('receipterStatus');
                if (status) { status.textContent = 'Receipter not configured.'; status.style.color = '#6b7280'; }
                return; 
            }
            const r = makeReceipt();
            const status = document.getElementById('receipterStatus');
            if (status) { status.textContent = 'Sending receipt to Receipter…'; status.style.color = '#6b7280'; }
            try {
                const res = await fetch(receipterUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(r) });
                if (!res.ok) throw new Error('Failed: ' + res.status);
                let body = {};
                try { body = await res.json(); } catch(e) {}
                if (status) { status.textContent = body.verified ? 'Receipt stored & VERIFIED on Receipter.' : 'Receipt stored (not yet verified).'; status.style.color = body.verified ? '#059669' : '#d97706'; }
            } catch (e) {
                if (status) { status.textContent = 'Auto send failed: ' + e.message + ' (You can manually download & upload later)'; status.style.color = '#dc2626'; }
            }
        }

        function openReceipterWithHash(){
            const page = '{{ receipter_page_url }}';
            if (!page) { 
                const status = document.getElementById('receipterStatus');
                if (status) { status.textContent = 'Receipter page URL not configured.'; status.style.color = '#6b7280'; }
                return; 
            }
            const r = makeReceipt();
            const encoded = encodeURIComponent(btoa(JSON.stringify(r)));
            window.open(page + '#r=' + encoded, '_blank');
        }
        // Auto attempt to send to Receipter on load (non-blocking)
        document.addEventListener('DOMContentLoaded', () => {
            const hasReceipter = !!'{{ receipter_url }}';
            const hasReceipterPage = !!'{{ receipter_page_url }}';
            const btnSend = document.getElementById('btnSendReceipter');
            const btnOpen = document.getElementById('btnOpenReceipter');
            const autoWrap = document.getElementById('autoSendWrap');
            if (!hasReceipter) {
                if (btnSend) btnSend.style.display = 'none';
                if (autoWrap) { autoWrap.style.display = 'none'; const t = document.getElementById('autoSendToggle'); if (t) t.checked=false; }
                const status = document.getElementById('receipterStatus');
                if (status) { status.textContent = 'Receipter integration disabled.'; status.style.color = '#6b7280'; }
            }
            if (!hasReceipterPage && btnOpen) btnOpen.style.display = 'none';
            // Only auto-send if configured and enabled
            if (hasReceipter && document.getElementById('autoSendToggle')?.checked) {
                sendToReceipter();
            }
        });
    </script>
</head>
<body>
    <div id="rcpt" class="card" data-poll="{{ poll_id }}" data-entry="{{ entry_hash }}" data-index="{{ index }}" data-head="{{ head }}" data-ts="{{ ts }}" data-file="{{ file_id }}">
        <h1>Your Vote Receipt</h1>
        <p>Thanks for voting in <strong>{{ poll_id }}</strong>. Keep this receipt to independently verify your vote was included in the public log.</p>
    <div class="row">Entry hash: <code>{{ entry_hash }}</code></div>
    <div class="row">Log index: <code>{{ index }}</code></div>
    <div class="row">Chain head (after your vote): <code>{{ head }}</code></div>

        <h3>Keep your receipt</h3>
        <p>
            <button onclick="saveLocal()">Save to this browser</button>
            <button onclick="downloadReceipt()">Download JSON</button>
            <button id="btnSendReceipter" onclick="sendToReceipter()">Send to Receipter</button>
            <button id="btnOpenReceipter" onclick="openReceipterWithHash()">Open Receipter (auto-import)</button>
            <label id="autoSendWrap" style="margin-left:0.5rem;font-size:0.85rem;">
                <input type="checkbox" id="autoSendToggle" checked> auto-send
            </label>
        </p>
        <div id="receipterStatus" style="font-size:0.9rem;margin-top:0.25rem;color:#6b7280;">Auto-sending…</div>

        <h3>Verify</h3>
        <ol>
            <li>Download the transparency log: <a href="{{ download_log_url or url_for('download_log') }}">votes_log.jsonl</a> and search for your <code>entry_hash</code>.</li>
            <li>
                Download the latest chain head file: <a href="{{ download_head_url or url_for('download_chain_head') }}">chain_head.txt</a>.
                If you have the OpenTimestamps CLI, you can verify the timestamp of the chain head locally.
            </li>
        </ol>

        <p>
            <a href="{{ results_url or url_for('results') }}">See results</a> ·
            <a href="{{ back_url or url_for('index') }}">Back to poll</a> ·
            <a href="{{ receipter_page_url }}" target="_blank">Open Receipter</a>
        </p>
    </div>
</body>
</html>
