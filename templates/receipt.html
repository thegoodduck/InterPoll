<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vote Receipt</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; margin: 2rem; }
        .card { max-width: 760px; padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        code { background: #f3f4f6; padding: 0.2rem 0.3rem; border-radius: 6px; }
        a { color: #2563eb; text-decoration: none; }
        .row { margin: 0.5rem 0; }
    </style>
    <script>
        // Minimal 256-word list for mnemonic-like phrase (not BIP39)
        const WORDS = [
          'apple','angle','art','atom','aqua','award','axis','azure','baby','bacon','badge','ballet','bamboo','banana','basic','beach','beam','beard','beauty','beaver','become','beef','begin','behave','being','believe','bell','bench','benefit','berry','beyond','bicycle','bid','big','bike','bird','birth','bison','bitter','black','blade','blame','blank','blast','blaze','bleak','blend','bless','blind','blink','block','blonde','blood','bloom','blue','bluff','board','boat','body','boil','bold','bolt','bomb','bond','bone','bonus','book','boost','border','bore','born','boss','both','bother','bottle','bottom','bounce','box','boy','brain','brand','brave','bread','break','breeze','brick','bridge','brief','bright','bring','broad','broken','bronze','broom','brown','brush','bubble','buddy','budget','buffalo','build','bulb','bulk','bullet','bundle','bunker','burden','burger','burst','bus','bush','business','busy','butter','buyer','cabin','cable','cactus','cake','calm','camera','camp','canal','candy','canoe','canvas','canyon','capital','captain','car','carbon','card','career','cargo','carpet','carry','cart','case','cash','casino','castle','casual','cat','catalog','catch','cattle','cause','cave','ceiling','celery','cement','census','century','cereal','certain','chain','chair','chalk','champion','change','chaos','charge','charm','chart','check','cheese','chef','cherry','chest','chicken','chief','child','chimney','choice','choose','chop','chorus','circle','city','civil','claim','clap','clarify','clay','clean','clerk','clever','click','client','cliff','climb','clinic','clip','clock','close','cloth','cloud','clown','club','clue','cluster','coach','coal','coast','coconut','code','coffee','coin','cold','collar','color','column','combine','come','comfort','comic','common','company','concert','conduct','confirm','connect','consider','control','cookie','cool','copper','copy','coral','core','corn','correct','cost','cotton','couch','country','couple','course','cousin','cover','coyote','crack','craft','crane','crash','crater','crawl','crazy','cream','credit','creek','crew','cricket','crime','crisp','critic','crop','cross','crouch','crowd','cruise','crumble','crystal','cube','culture','cup','curious','current','curtain','curve','cushion','custom','cute','cycle'
        ];

        function normalizePhrase(s){
            return (s || '').trim().toLowerCase().split(/\s+/).join(' ');
        }

        function ensureMnemonic(){
            let m = localStorage.getItem('interpoll_mnemonic') || '';
            m = normalizePhrase(m);
            if (!m) {
                const arr = [];
                const cryptoObj = window.crypto || window.msCrypto;
                const buf = new Uint32Array(12);
                cryptoObj.getRandomValues(buf);
                for (let i=0;i<12;i++) arr.push(WORDS[buf[i] % WORDS.length]);
                m = arr.join(' ');
                localStorage.setItem('interpoll_mnemonic', m);
            }
            return m;
        }

        async function sha256Hex(str){
            const enc = new TextEncoder().encode(str);
            const digest = await crypto.subtle.digest('SHA-256', enc);
            const bytes = Array.from(new Uint8Array(digest));
            return bytes.map(b => b.toString(16).padStart(2,'0')).join('');
        }

        async function getUserId(){
            const mn = ensureMnemonic();
            const uid = await sha256Hex(mn);
            return { uid, mnemonic: mn };
        }

        function makeReceipt() {
            const el = document.getElementById('rcpt');
            return {
                poll_id: el.dataset.poll,
                entry_hash: el.dataset.entry,
                index: parseInt(el.dataset.index, 10),
                chain_head: el.dataset.head,
                timestamp: el.dataset.ts,
                file_id: el.dataset.file
            };
        }

        function saveLocal() {
            const r = makeReceipt();
            const key = 'interpoll_receipts';
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            // dedupe by entry_hash
            if (!existing.find(x => x.entry_hash === r.entry_hash)) {
                existing.push(r);
                localStorage.setItem(key, JSON.stringify(existing));
            }
            alert('Receipt saved in this browser.');
        }

        function downloadReceipt() {
            const r = makeReceipt();
            const blob = new Blob([JSON.stringify(r, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt_${r.index}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        async function sendToReceipter() {
            const receipterUrl = '{{ receipter_url }}';
            if (!receipterUrl) { 
                const status = document.getElementById('receipterStatus');
                if (status) { status.textContent = 'Receipter not configured.'; status.style.color = '#6b7280'; }
                return; 
            }
            const r = makeReceipt();
            try {
                const { uid } = await getUserId();
                r.user_id = uid;
            } catch(e) {}
            const status = document.getElementById('receipterStatus');
            if (status) { status.textContent = 'Sending receipt to Receipter…'; status.style.color = '#6b7280'; }
            try {
                const res = await fetch(receipterUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(r) });
                if (!res.ok) throw new Error('Failed: ' + res.status);
                let body = {};
                try { body = await res.json(); } catch(e) {}
                if (status) { status.textContent = body.verified ? 'Receipt stored & VERIFIED on Receipter.' : 'Receipt stored (not yet verified).'; status.style.color = body.verified ? '#059669' : '#d97706'; }
            } catch (e) {
                if (status) { status.textContent = 'Auto send failed: ' + e.message + ' (You can manually download & upload later)'; status.style.color = '#dc2626'; }
                window.__receipterOk = true;
            }
        }

                window.__receipterOk = false;
        async function openReceipterWithHash(){
            const page = '{{ receipter_page_url }}';
            if (!page) { 
                const status = document.getElementById('receipterStatus');
                if (status) { status.textContent = 'Receipter page URL not configured.'; status.style.color = '#6b7280'; }
                return; 
            }
            const r = makeReceipt();
            try {
                const { uid } = await getUserId();
                r.user_id = uid;
            } catch(e) {}
            const encoded = encodeURIComponent(btoa(JSON.stringify(r)));
            window.open(page + '#r=' + encoded, '_blank');
        }
        // Auto attempt to send to Receipter on load (non-blocking)
        document.addEventListener('DOMContentLoaded', () => {
            const hasReceipter = !!'{{ receipter_url }}';
            const hasReceipterPage = !!'{{ receipter_page_url }}';
            const btnSend = document.getElementById('btnSendReceipter');
            const btnOpen = document.getElementById('btnOpenReceipter');
            const autoWrap = document.getElementById('autoSendWrap');
            if (!hasReceipter) {
                const triggerAuto = document.getElementById('autoSendToggle')?.checked || enforce;
                if (triggerAuto) sendToReceipter();
                if (enforce) {
                    const links = document.querySelectorAll('a.require-ok');
                    links.forEach(a => {
                        a.addEventListener('click', (e) => {
                            if (!window.__receipterOk) {
                                e.preventDefault();
                                const s = document.getElementById('receipterStatus');
                                if (s) { s.textContent = 'Please wait — pushing receipt to Receipter…'; s.style.color = '#b45309'; }
                                sendToReceipter();
                            }
                        });
                    });
                }
                if (autoWrap) { autoWrap.style.display = 'none'; const t = document.getElementById('autoSendToggle'); if (t) t.checked=false; }
                const status = document.getElementById('receipterStatus');
                if (status) { status.textContent = 'Receipter integration disabled.'; status.style.color = '#6b7280'; }
            }
            if (!hasReceipterPage && btnOpen) btnOpen.style.display = 'none';
            // Show or generate mnemonic
            try {
                const m = ensureMnemonic();
                const mnEl = document.getElementById('mnemonic');
                if (mnEl) mnEl.textContent = m;
            } catch(e) {}
            // Only auto-send if configured and enabled
            if (hasReceipter && document.getElementById('autoSendToggle')?.checked) {
                sendToReceipter();
            }
        });
    </script>
</head>
<body>
    <div id="rcpt" class="card" data-poll="{{ poll_id }}" data-entry="{{ entry_hash }}" data-index="{{ index }}" data-head="{{ head }}" data-ts="{{ ts }}" data-file="{{ file_id }}">
        <h1>Your Vote Receipt</h1>
        <p>Thanks for voting in <strong>{{ poll_id }}</strong>. Keep this receipt to independently verify your vote was included in the public log.</p>
    <div class="row">Entry hash: <code>{{ entry_hash }}</code></div>
    <div class="row">Log index: <code>{{ index }}</code></div>
    <div class="row">Chain head (after your vote): <code>{{ head }}</code></div>

        <h3>Keep your receipt</h3>
        <p>
            <button onclick="saveLocal()">Save to this browser</button>
            <button onclick="downloadReceipt()">Download JSON</button>
            <button id="btnSendReceipter" onclick="sendToReceipter()">Send to Receipter</button>
            <button id="btnOpenReceipter" onclick="openReceipterWithHash()">Open Receipter (auto-import)</button>
            <label id="autoSendWrap" style="margin-left:0.5rem;font-size:0.85rem;">
                <input type="checkbox" id="autoSendToggle" checked> auto-send
            </label>
        </p>
        <div id="receipterStatus" style="font-size:0.9rem;margin-top:0.25rem;color:#6b7280;">Auto-sending…</div>

                <h3>Your recovery phrase</h3>
                <p>These 12 words identify you for Receipter. Save them to recover all your receipts on any Receipter server:</p>
                <p style="background:#f8fafc;border:1px dashed #cbd5e1;padding:10px;border-radius:8px;">
                    <code id="mnemonic" style="font-size:0.95rem"></code>
                </p>
                <p class="note" style="color:#6b7280;font-size:0.9rem;">Anyone with this phrase can fetch the list of your receipts. Do not share it unless you understand the privacy implications.</p>

        <h3>Verify</h3>
        <ol>
            <li>Download the transparency log: <a href="{{ download_log_url or url_for('download_log') }}">votes_log.jsonl</a> and search for your <code>entry_hash</code>.</li>
            <li>
                Download the latest chain head file: <a href="{{ download_head_url or url_for('download_chain_head') }}">chain_head.txt</a>.
                If you have the OpenTimestamps CLI, you can verify the timestamp of the chain head locally.
            </li>
        </ol>

        <p>
              <a class="require-ok" href="{{ results_url or url_for('results') }}">See results</a> ·
              <a class="require-ok" href="{{ back_url or url_for('index') }}">Back to poll</a> ·
            <a href="{{ receipter_page_url }}" target="_blank">Open Receipter</a>
        </p>
    </div>
</body>
</html>
