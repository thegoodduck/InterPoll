<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ poll.question }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; background:#f8fafc; }
    .shell { max-width: 680px; margin: 32px auto; padding: 0 16px; }
    .card { background: #fff; border:1px solid #e5e7eb; border-radius: 14px; box-shadow:0 2px 8px rgba(0,0,0,.05); padding: 18px; }
    .option { display:block; margin: 8px 0; }
    .actions { margin-top: 12px; }
    button { padding: 8px 12px; border-radius: 10px; border:1px solid #2563eb; background:#2563eb; color:#fff; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <h2 style="margin:0 0 10px 0;">{{ poll.question }}</h2>
      <p class="note" style="margin:6px 0 12px 0;">
        {% if poll.allow_multiple %}
          This poll allows multiple votes from the same device.
        {% else %}
          This poll allows a single vote per device/account.
        {% endif %}
        {% if poll.min_session_age %}
          • You must keep this page open for at least {{ poll.min_session_age }} minute(s) before voting.
        {% endif %}
      </p>
      {% if voted %}
        <p>Thanks, your vote was recorded. <a href="{{ url_for('poll_results', poll_id=poll.id) }}">See results</a>.</p>
      {% else %}
        {% if not can_vote %}
          {% set req = (poll.login_required or 'none')|lower %}
          <div style="margin:10px 0; color:#b45309;">
            {% if req == 'google' %}
              This poll requires Google sign-in.
              <a href="{{ url_for('login_google') }}">Sign in with Google</a>
            {% elif req == 'idena' %}
              This poll requires Idena sign-in.
              <a href="{{ url_for('login_idena') }}">Sign in with Idena</a>
            {% elif req == 'microsoft' %}
              This poll requires Microsoft sign-in.
              <a href="{{ url_for('login_microsoft') }}">Sign in with Microsoft</a>
            {% elif req == 'any' %}
              This poll requires sign-in.
              <a href="{{ url_for('login_google') }}">Google</a> ·
              <a href="{{ url_for('login_microsoft') }}">Microsoft</a> ·
              <a href="{{ url_for('login_idena') }}">Idena</a>
            {% endif %}
          </div>
        {% else %}
        <form method="POST" action="{{ url_for('poll_vote', poll_id=poll.id) }}" id="vote-form">
          {% for opt in poll.options %}
          <label class="option">
            <input type="radio" name="vote" value="{{ opt }}" required /> {{ opt }}
          </label>
          {% endfor %}
          {% if poll.location_required %}
          <input type="hidden" name="lat" id="geo-lat" />
          <input type="hidden" name="lon" id="geo-lon" />
          <div id="geo-status" style="font-size:0.9em; color:#555; margin-top:6px;">
            Obtaining location (for single-vote protection)...
          </div>
          {% endif %}
          <div class="actions">
            <button type="submit" id="vote-btn">Vote</button>
            <a style="margin-left:10px" href="{{ url_for('poll_results', poll_id=poll.id) }}">See results</a>
          </div>
        </form>
        {% if poll.min_session_age %}
        <script>
        (function() {
          const btn = document.getElementById('vote-btn');
          const started = Number('{{ session.session_started_at or 0 }}');
          const minMins = Number('{{ poll.min_session_age or 0 }}');
          if (!started || !minMins) return;
          const req = started*1000 + minMins*60*1000;
          function tick(){
            const now = Date.now();
            const remainMs = req - now;
            if (remainMs <= 0) { btn.disabled = false; return; }
            btn.disabled = true;
            const mins = Math.ceil(remainMs/60000);
            btn.textContent = 'Vote (available in ~' + mins + 'm)';
            requestAnimationFrame(tick);
          }
          tick();
        })();
        </script>
        {% endif %}
        {% if poll.location_required %}
        <script>
        (function() {
          const btn = document.getElementById('vote-btn');
          const latEl = document.getElementById('geo-lat');
          const lonEl = document.getElementById('geo-lon');
          const statusEl = document.getElementById('geo-status');
          if (!navigator.geolocation) {
            statusEl.textContent = 'Geolocation not supported by this browser.';
            btn.disabled = true;
            return;
          }
          btn.disabled = true;
          navigator.geolocation.getCurrentPosition(function(pos) {
            latEl.value = pos.coords.latitude.toFixed(6);
            lonEl.value = pos.coords.longitude.toFixed(6);
            statusEl.textContent = 'Location locked (rounded & hashed, not stored raw publicly).';
            btn.disabled = false;
          }, function(err) {
            statusEl.textContent = 'Unable to get location (' + err.message + '). Cannot vote on this location-required poll.';
            btn.disabled = true;
          }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        })();
        </script>
        {% endif %}
        {% endif %}
      {% endif %}
      <p style="margin-top:14px"><a href="{{ url_for('index') }}">All polls</a></p>
    </div>
  </div>
</body>
</html>
