<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>InterPoll</title>
    <style>
        :root { --brand:#2563eb; --fg:#0f172a; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb; --bg:#f8fafc; }
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; background: var(--bg); color: var(--fg); }
        .shell { max-width: 880px; margin: 32px auto; padding: 0 16px; }
        .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
        .header h1 { margin:0; font-size: 1.5rem; letter-spacing: -0.2px; }
        .toolbar a.btn { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--brand); color:#fff; background: var(--brand); text-decoration:none; font-weight:500; }
        .stack { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .card { background: var(--card); border:1px solid var(--line); border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 16px 18px; }
        .section-title { margin: 0 0 8px 0; font-size: 1.1rem; }
        .status { font-size: 0.92rem; color: var(--muted); }
        .status .chip { display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; background:#f1f5f9; color:#334155; }
        .option { margin: 0.5rem 0; display:block; }
        .actions { margin-top: 1rem; }
        button { padding: 0.6rem 1rem; border-radius: 10px; border: 1px solid var(--brand); background: var(--brand); color: white; cursor: pointer; }
        button:disabled { background: #9ca3af; border-color: #9ca3af; cursor: not-allowed; }
        .note { color: var(--muted); font-size: 0.9rem; }
        .success { color: #059669; }
        a { color: var(--brand); text-decoration: none; }
        .poll-list { list-style:none; margin: 8px 0 0 0; padding:0; }
        .poll-item { padding: 12px 10px; border-top: 1px dashed var(--line); display:flex; align-items:baseline; gap:10px; }
        .poll-item:first-child { border-top: none; }
        .poll-title { font-weight: 600; }
        .poll-meta { color: var(--muted); font-size: 0.88rem; }
    </style>
    <script>
        function onSubmit(e){
            const btn = document.getElementById('voteBtn');
            btn.disabled = true; btn.textContent = 'Submitting…';
        }
    </script>
    <script>
        // Basic client-side guard to discourage quick revotes in same tab
        document.addEventListener('DOMContentLoaded', () => {
            const voted = document.body.dataset.voted === 'true';
            if (voted) {
                const btn = document.getElementById('voteBtn');
                if (btn) btn.disabled = true;
            }
        });
    </script>
    <script>
        // Idena login with polling while keeping current page intact to avoid about:blank navigation issues.
        async function loginWithIdena() {
            const statusEl = ensureStatusEl();
            setStatus(statusEl, 'Starting Idena login…');
            try {
                const initRes = await fetch('/auth/v1/init', {method:'POST'});
                const initData = await initRes.json();
                if(!initData.success) { setStatus(statusEl, 'Init failed'); return; }
                const token = initData.token;
                // Open external wallet / web signin without unloading this page.
                const url = initData.signin_url;
                try {
                    if (url.startsWith('dna://')) {
                        // custom protocol: simulate click on hidden link
                        const a = document.createElement('a');
                        a.href = url; a.style.display='none'; document.body.appendChild(a); a.click();
                    } else {
                        window.open(url, '_blank', 'noopener');
                    }
                } catch(openErr) {
                    setStatus(statusEl, 'Popup blocked – please allow popups or click this link: ' + url);
                }
                const start = Date.now();
                const poll = async () => {
                    if (Date.now() - start > 180000) { setStatus(statusEl, 'Login timed out.'); return; }
                    try {
                        const r = await fetch(`/auth/v1/status?token=${encodeURIComponent(token)}`);
                        if (r.ok) {
                            const s = await r.json();
                            if (s.authenticated) {
                                setStatus(statusEl, 'Finalizing…');
                                await fetch('/auth/v1/finalize', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({token})});
                                window.location.reload();
                                return;
                            }
                        }
                    } catch(e) {
                        /* ignore transient errors */
                    }
                    setTimeout(poll, 2000);
                };
                setTimeout(poll, 2000);
                setStatus(statusEl, 'Waiting for signature in wallet…');
            } catch (e) {
                setStatus(statusEl, 'Error: ' + e);
            }
        }
        function ensureStatusEl(){
            let el = document.getElementById('idenaStatus');
            if(!el){
                el = document.createElement('div');
                el.id = 'idenaStatus';
                el.style.marginTop = '0.75rem';
                el.style.fontSize = '0.8rem';
                el.style.color = '#374151';
                const container = document.querySelector('.card');
                container.appendChild(el);
            }
            return el;
        }
        function setStatus(el, msg){ el.textContent = msg; }
    </script>
</head>
<body data-voted="{{ 'true' if voted else 'false' }}">
    <div class="shell">
        <div class="header">
            <h1>InterPoll</h1>
            <div class="toolbar">
                <a class="btn" href="{{ url_for('create_poll') }}">Create poll</a>
            </div>
        </div>

        <div class="stack">
            <!-- Auth status / entry -->
            <div class="card">
                <p class="section-title">Status</p>
                {% if user %}
                    <p class="status">Signed in as
                        <span class="chip">
                        {% if user.email %}{{ user.email }}{% elif user.address %}{{ user.address }}{% elif user.name %}{{ user.name }}{% else %}user{% endif %}
                        </span>
                        via <strong>{{ user._provider }}</strong>
                        · <a href="{{ url_for('logout') }}">Logout</a>
                    </p>
                    <p class="note">Sign-in is optional — you can vote with or without an account.</p>
                {% else %}
                    <p class="status">Sign-in is optional — you can vote without an account. If you prefer, sign in with 
                        <a href="{{ url_for('login_google') }}">Google</a>, 
                        <a href="{{ url_for('login_microsoft') }}">Microsoft</a> or 
                        <a href="javascript:void(0)" onclick="loginWithIdena()">Idena</a>.
                    </p>
                {% endif %}
                                {% if GOV_ID_ENABLED %}
                                <div style="margin-top:12px; padding:10px; border:1px solid var(--line); border-radius:10px; background:#f1f5f9;">
                                    <strong>Government ID (one-person verification)</strong>
                                    <p class="note" style="margin:6px 0 8px 0;">Optional extra assurance: register once to guarantee one human = one vote. We never store raw ID images – only salted hashes and a face embedding vector.</p>
                                    {% if session.voter %}
                                        <p class="status success">Verified voter ID #{{ session.voter.voter_id }} · one vote limit enforced.</p>
                                    {% else %}
                                    <form method="post" action="/auth/login" enctype="multipart/form-data" style="margin-bottom:6px; display:flex; flex-direction:column; gap:6px;">
                                        <input name="full_name" placeholder="Full name on ID" required />
                                        <input name="dob" placeholder="Date of birth (YYYY-MM-DD)" required />
                                        <input name="id_number" placeholder="ID Number" required />
                                        <input type="file" name="selfie" accept="image/*" {% if GOV_ID_REQUIRE_FACE %}required{% endif %} />
                                        <button style="align-self:flex-start;">Gov ID Login</button>
                                    </form>
                                    <details style="font-size:0.75rem; line-height:1.1;">
                                        <summary style="cursor:pointer;">Need to register first?</summary>
                                        <form method="post" action="/auth/register" enctype="multipart/form-data" style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
                                            <input name="full_name" placeholder="Full name on ID" required />
                                            <input name="dob" placeholder="Date of birth (YYYY-MM-DD)" required />
                                            <input name="id_number" placeholder="ID Number" required />
                                            <input name="expiry" placeholder="Expiry (optional)" />
                                            <label style="font-size:0.7rem;">ID Image <input type="file" name="id_image" accept="image/*" required /></label>
                                            <label style="font-size:0.7rem;">Selfie <input type="file" name="selfie" accept="image/*" {% if GOV_ID_REQUIRE_FACE %}required{% endif %} /></label>
                                            <button style="align-self:flex-start;">Register Gov ID</button>
                                        </form>
                                    </details>
                                    {% endif %}
                                </div>
                                {% endif %}
            </div>

            <!-- Poll directory only, with search -->
            <div class="card">
                <p class="section-title">Available polls</p>
                <input id="search" type="search" placeholder="Search polls…" style="width:100%;padding:10px;border-radius:10px;border:1px solid #e5e7eb" oninput="filterPolls()" />
                {% if polls and polls|length > 0 %}
                    <ul id="pollList" class="poll-list">
                        {% for p in polls %}
                        <li class="poll-item" data-title="{{ p.question|lower }}">
                            <div>
                                <div class="poll-title"><a href="{{ url_for('poll_detail', poll_id=p.id) }}">{{ p.question }}</a></div>
                                <div class="poll-meta">
                                    {{ p.options|length }} option{{ '' if (p.options|length)==1 else 's' }}
                                    {% if p.created %} • created {{ p.created }}{% endif %}
                                </div>
                                <div class="poll-meta"><a href="{{ url_for('poll_results', poll_id=p.id) }}">Results</a> • Share: <code>{{ request.host_url.rstrip('/') }}{{ url_for('poll_detail', poll_id=p.id) }}</code></div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="note">No polls yet. Create one to get started.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <script>
      function filterPolls(){
        const q = (document.getElementById('search').value || '').toLowerCase();
        const items = document.querySelectorAll('#pollList .poll-item');
        items.forEach(li => {
          const t = li.getAttribute('data-title') || '';
          li.style.display = (!q || t.includes(q)) ? '' : 'none';
        });
      }
    </script>
</body>
</html>
